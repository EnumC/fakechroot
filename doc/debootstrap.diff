Index: debootstrap
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/debootstrap,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- debootstrap	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ debootstrap	9 Aug 2003 00:15:28 -0000	1.2
@@ -48,4 +48,5 @@
       --components=A,B,C     use packages from the listed components of the 
                              archive
+      --fakechroot           build in fakechroot environment
 EOF
 }
@@ -121,4 +122,9 @@
     USE_COMPONENTS="$(echo "$1" | cut -f2 -d"="|tr , "|")"
     export USE_COMPONENTS
+    shift 1
+    ;;
+  --fakechroot)
+    fakechroot=true
+    export fakechroot
     shift 1
     ;;
Index: debootstrap.8
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/debootstrap.8,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- debootstrap.8	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ debootstrap.8	9 Aug 2003 01:12:14 -0000	1.2
@@ -52,4 +52,7 @@
 .IP "\fB--debian-installer\fP"
 Used for internal purposes by the debian-installer
+.IP
+.IP "\fB--fakechroot\fP"
+Used if build in fakechroot environment
 .IP 
 .SH "EXAMPLE"
Index: functions
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/functions,v
retrieving revision 1.1.1.1
retrieving revision 1.3
diff -u -2 -r1.1.1.1 -r1.3
--- functions	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ functions	9 Aug 2003 01:09:26 -0000	1.3
@@ -543,7 +543,14 @@
 
 setup_proc () {
-  on_exit "umount $TARGET/proc"
-  umount $TARGET/proc 2>/dev/null || true
-  in_target mount -t proc proc /proc
+  if [ "$fakechroot" != "true" ]; then
+    on_exit "umount $TARGET/proc"
+    umount $TARGET/proc 2>/dev/null || true
+    in_target mount -t proc proc /proc
+  else
+    for i in cmdline cpuinfo devices filesystems loadavg meminfo misc modules partitions stat swaps uptime version; do
+        cat /proc/$i > $TARGET/proc/$i
+    done
+    mkdir $TARGET/proc/1
+  fi
 }
 
@@ -553,5 +560,7 @@
   else
     if [ -e /dev/.devfsd ]; then
-      in_target mount -t devfs devfs /dev
+      if [ "$fakechroot" != "true" ]; then
+        in_target mount -t devfs devfs /dev
+      fi
     else
       error 1 NODEVTGZ "no %s. cannot create devices" "$DEVICES_TARGZ"
@@ -609,3 +618,132 @@
   eval `echo EXIT_THING_${N_EXIT_THINGS}=\"$1\"`
   N_EXIT_THINGS="$(( $N_EXIT_THINGS + 1 ))"
+}
+
+################################################################### fake tools
+
+install_fake_tools () {
+  mv "$TARGET/sbin/ldconfig" "$TARGET/sbin/ldconfig.REAL"
+  echo \
+"#!/bin/sh
+echo
+echo \"Warning: Fake ldconfig called, doing nothing\"" > "$TARGET/sbin/ldconfig"
+  chmod 755 "$TARGET/sbin/ldconfig"
+
+  echo \
+"/sbin/ldconfig
+/sbin/ldconfig.REAL
+fakechroot" >> "$TARGET/var/lib/dpkg/diversions"
+
+  mv "$TARGET/usr/bin/ldd" "$TARGET/usr/bin/ldd.REAL"
+  cat << 'END' > "$TARGET/usr/bin/ldd"
+#!/usr/bin/perl
+
+# fakeldd
+#
+# Replacement for ldd with usage of objdump
+#
+# (c) 2003 Piotr Roszatycki <dexter@debian.org>, GPL
+
+
+my %libs = ();
+my @ld_library_path = qw(/usr/lib /lib);
+my $status = 0;
+my $dynamic = 0;
+
+sub ldso($) {
+    my ($lib) = @_;
+    my @files = ();
+    
+    foreach my $ld_path (@ld_library_path) {
+	-f "$ld_path/$lib" or next;
+	$libs{$lib} = "$ld_path/$lib";
+	push @files, "$ld_path/$lib";
+    }
+
+    objdump(@files);
+}
+
+sub objdump(@) {
+    my (@files) = @_;
+    my @libs = ();
+
+    foreach my $file (@files) {
+	open OBJDUMP, "objdump -p $file 2>/dev/null |";
+	while (my $line = <OBJDUMP>) {
+	    $line =~ s/^\s+//;
+	    my @f = split (/\s+/, $line);
+	    if ($f[0] eq "Dynamic") {
+		$dynamic = 1;
+	    }
+	    $f[0] eq "NEEDED" or next;
+	    if (! defined $libs{$f[1]}) {
+	        $libs{$f[1]} = undef;
+		push @libs, $f[1];
+	    }
+	}
+	close OBJDUMP;
+    }
+
+    foreach my $lib (@libs) {
+	ldso($lib);
+    }
+}
+
+
+if ($#ARGV < 0) {
+    print STDERR "fakeldd: missing file arguments\n";
+    exit 1;
+}
+
+open LD_SO_CONF, "/etc/ld.so.conf";
+while ($line = <LD_SO_CONF>) {
+    chomp $line;
+    unshift @ld_library_path, $line;
+}
+close LD_SO_CONF;
+
+unshift @ld_library_path, split(/:/, $ENV{LD_LIBRARY_PATH});
+
+foreach my $file (@ARGV) {
+    %libs = ();
+    $dynamic = 0;
+
+    if ($#ARGV > 0) {
+	print "$file:\n";
+    }
+
+    if (! -f $file) {
+	print STDERR "ldd: $file: No such file or directory\n";
+	$status = 1;
+	next;
+    }
+
+    objdump($file);
+    
+    if ($dynamic == 0) {
+	print "\tnot a dynamic executable\n";
+	$status = 1;
+    } elsif (scalar %libs eq "0") {
+	print "\tstatically linked\n";
+    }
+
+    foreach $lib (keys %libs) {
+	if ($libs{$lib}) {
+    	    printf "\t%s => %s (0x00000000)\n", $lib, $libs{$lib};
+	} else {
+	    printf "\t%s => not found\n", $lib;
+	}
+    }
+    
+}
+
+exit $status;
+END
+  chmod 755 "$TARGET/usr/bin/ldd"
+
+  echo \
+"/usr/bin/ldd
+/usr/bin/ldd.REAL
+fakechroot" >> "$TARGET/var/lib/dpkg/diversions"
+
 }
Index: potato
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/potato,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- potato	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ potato	9 Aug 2003 00:15:28 -0000	1.2
@@ -43,6 +43,8 @@
     setup_devices
 
-    ln "$TARGET/sbin/ldconfig.new" "$TARGET/sbin/ldconfig"
-    in_target /sbin/ldconfig
+    if [ "$fakechroot" != "true" ]; then
+        ln "$TARGET/sbin/ldconfig.new" "$TARGET/sbin/ldconfig"
+        in_target /sbin/ldconfig
+    fi
 
     x_feign_install () {
@@ -80,4 +82,8 @@
     fi
 
+    if [ "$fakechroot" = "true" ]; then
+        install_fake_tools
+    fi
+
     x_core_install base-files base-passwd ldso
     x_core_install dpkg
@@ -98,5 +104,7 @@
 
     setup_dselect_method apt
-    on_exit "in_target umount /dev/pts"
+    if [ "$fakechroot" != "true" ]; then
+	on_exit "in_target umount /dev/pts"
+    fi
 
     in_target dpkg --configure --pending --force-configure-any --force-depends
Index: sarge
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/sarge,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- sarge	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ sarge	9 Aug 2003 00:15:28 -0000	1.2
@@ -112,5 +112,7 @@
     setup_devices
 
-    in_target /sbin/ldconfig
+    if [ "$fakechroot" != "true" ]; then
+        in_target /sbin/ldconfig
+    fi
 
     p () {
@@ -164,4 +166,8 @@
     fi
 
+    if [ "$fakechroot" = "true" ]; then
+        install_fake_tools
+    fi
+
     p; progress $baseprog $bases INSTBASE "Installing base system" #4
     x_core_install $LIBC6
@@ -191,5 +197,7 @@
 
     setup_dselect_method apt
-    on_exit "in_target_nofail umount /dev/pts"
+    if [ "$fakechroot" != "true" ]; then
+        on_exit "in_target_nofail umount /dev/pts"
+    fi
 
     p; progress $baseprog $bases INSTBASE "Installing base system" #19
Index: sid
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/sid,v
retrieving revision 1.1.1.1
retrieving revision 1.3
diff -u -2 -r1.1.1.1 -r1.3
--- sid	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ sid	9 Aug 2003 01:09:26 -0000	1.3
@@ -8,4 +8,8 @@
     base="adduser apt apt-utils at base-config bsdmainutils console-common console-tools libconsole console-data cpio cron dhcp-client ed exim fdutils gettext-base groff-base ifupdown info klogd libdb1-compat libident libldap2 libgnutls7 libssl0.9.7 libgcrypt1 liblzo1 libopencdk4 libtasn1-0 zlib1g liblockfile1 libpcre3 libsasl2 libtext-iconv-perl libwrap0 logrotate mailx man-db manpages modconf nano net-tools netbase netkit-inetd iputils-ping nvi ppp pppconfig pppoe pppoeconf libpcap0.7 sysklogd tasksel tcpd telnet wget $additional"
 
+    if [ "$fakechroot" = "true" ]; then
+        required="$required fakeroot fakechroot"
+    fi
+
     without_package () {
         echo "$2" | tr ' ' '\n' | grep -v "^$1$" | tr '\n' ' '
@@ -112,5 +116,7 @@
     setup_devices
 
-    in_target /sbin/ldconfig
+    if [ "$fakechroot" != "true" ]; then
+        in_target /sbin/ldconfig
+    fi
 
     p () {
@@ -164,4 +170,8 @@
     fi
 
+    if [ "$fakechroot" = "true" ]; then
+        install_fake_tools
+    fi
+
     p; progress $baseprog $bases INSTBASE "Installing base system" #4
     x_core_install $LIBC6
@@ -191,5 +201,7 @@
 
     setup_dselect_method apt
-    on_exit "in_target_nofail umount /dev/pts"
+    if [ "$fakechroot" != "true" ]; then
+        on_exit "in_target_nofail umount /dev/pts"
+    fi
 
     p; progress $baseprog $bases INSTBASE "Installing base system" #19
Index: slink
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/slink,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- slink	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ slink	9 Aug 2003 00:15:28 -0000	1.2
@@ -35,6 +35,8 @@
     mv "$TARGET/usr/bin/perl.dist" "$TARGET/usr/bin/perl"
 
-    ln "$TARGET/sbin/ldconfig.new" "$TARGET/sbin/ldconfig"
-    in_target /sbin/ldconfig
+    if [ "$fakechroot" != "true" ]; then
+        ln "$TARGET/sbin/ldconfig.new" "$TARGET/sbin/ldconfig"
+        in_target /sbin/ldconfig
+    fi
 
     x_feign_install () {
@@ -65,4 +67,8 @@
     x_core_install base-files base-passwd ldso
     x_core_install dpkg
+
+    if [ "$fakechroot" = "true" ]; then
+        install_fake_tools
+    fi
 
     ln -sf /usr/share/zoneinfo/UTC "$TARGET/etc/localtime"
Index: woody
===================================================================
RCS file: /cvsroot/cvsdebuild/debian/upstream/debootstrap/woody,v
retrieving revision 1.1.1.1
retrieving revision 1.2
diff -u -2 -r1.1.1.1 -r1.2
--- woody	8 Aug 2003 23:22:59 -0000	1.1.1.1
+++ woody	9 Aug 2003 00:15:28 -0000	1.2
@@ -101,5 +101,7 @@
     setup_devices
 
-    in_target /sbin/ldconfig
+    if [ "$fakechroot" != "true" ]; then
+        in_target /sbin/ldconfig
+    fi
 
     p () {
@@ -151,4 +153,8 @@
     fi
 
+    if [ "$fakechroot" = "true" ]; then
+        install_fake_tools
+    fi
+
     p; progress $baseprog $bases INSTBASE "Installing base system" #4
     x_core_install $LIBC6
@@ -178,5 +184,7 @@
 
     setup_dselect_method apt
-    on_exit "in_target_nofail umount /dev/pts"
+    if [ "$fakechroot" != "true" ]; then
+        on_exit "in_target_nofail umount /dev/pts"
+    fi
 
     p; progress $baseprog $bases INSTBASE "Installing base system" #19
